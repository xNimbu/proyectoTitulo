<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mis Posts</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea, input, button { width: 100%; margin-bottom: 10px; padding: 8px; }
    .post { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .photo { max-width: 100%; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>Ver mis publicaciones</h2>

  <label>Token Firebase:</label>
  <textarea id="token" rows="4" placeholder="Pega aquí tu token Firebase"></textarea>
  <button onclick="cargarPosts()">Cargar Posts</button>

  <hr>

  <h3>Crear nueva publicación</h3>
  <label>Texto:</label>
  <textarea id="postContent" rows="3" placeholder="¿Qué estás pensando?"></textarea>

  <label>Imagen:</label>
  <input type="file" id="imageInput" accept="image/*" />

  <button onclick="crearPost()">Publicar</button>

  <hr>

  <div id="resultados"></div>

  <script>
    async function cargarPosts() {
      const token = document.getElementById("token").value;
      const contenedor = document.getElementById("resultados");
      contenedor.innerHTML = "Cargando...";

      try {
        const res = await fetch("https://proyectotitulo.onrender.com/api/profile/posts/", {
          headers: {
            Authorization: "Bearer " + token,
          },
        });

        const data = await res.json();

        if (data.posts && Array.isArray(data.posts)) {
          contenedor.innerHTML = "";
          data.posts.forEach(post => {
            const div = document.createElement("div");
            div.className = "post";
            div.innerHTML = `
              <strong>Contenido:</strong> ${post.content || "(Sin contenido)"}<br>
              <strong>Fecha:</strong> ${new Date(post.timestamp).toLocaleString()}<br>
              ${post.photoURL ? `<img class="photo" src="${post.photoURL}" alt="imagen">` : ""}
            `;
            contenedor.appendChild(div);
          });
        } else {
          contenedor.innerHTML = "No se encontraron posts.";
        }
      } catch (err) {
        contenedor.innerHTML = "Error al obtener posts: " + err.message;
      }
    }

    async function crearPost() {
      const token = document.getElementById("token").value;
      const content = document.getElementById("postContent").value;
      const fileInput = document.getElementById("imageInput");

      let imageUrl = "";

      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        // Usamos imgur como demo rápida, puedes cambiar por tu propio endpoint
        const formData = new FormData();
        formData.append("image", file);

        const uploadRes = await fetch("https://api.imgbb.com/1/upload?key=add34ba93ab62f67b931e22df2c950c0", {
          method: "POST",
          body: formData,
        });

        const uploadData = await uploadRes.json();
        imageUrl = uploadData.data.url;
      }

      const res = await fetch("https://proyectotitulo.onrender.com/api/profile/posts/", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          content: content,
          photoURL: imageUrl,
        }),
      });

      const data = await res.json();
      alert("Post creado: " + data.mensaje);
      cargarPosts(); // recarga publicaciones
    }
  </script>

</body>
</html>

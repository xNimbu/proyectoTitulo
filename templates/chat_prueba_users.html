<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Chat de Prueba</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
    }

    #profiles {
      width: 25%;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }

    #profiles ul {
      list-style: none;
      padding: 0;
    }

    #profiles li {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    #profiles li.active {
      background: #f0f0f0;
    }

    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .msg {
      margin: 4px 0;
      max-width: 60%;
      padding: 6px 10px;
      border-radius: 8px;
    }

    .me {
      align-self: flex-end;
      background: #DCF8C6;
    }

    .them {
      align-self: flex-start;
      background: #F1F0F0;
    }

    #input {
      display: flex;
    }

    #input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-top: none;
    }

    #input button {
      padding: 8px 12px;
    }
  </style>
</head>

<body>
  <div id="profiles">
    <h3>Perfiles</h3>
    <ul id="list"></ul>
  </div>
  <div id="chat">
    <div id="messages"></div>
    <div id="input">
      <input id="msgInput" type="text" placeholder="Escribe un mensaje…">
      <button id="sendBtn">Enviar</button>
    </div>
  </div>

  <script>
    const apiBase = '/api';
    let socket = null;
    let currentRoom = null;
    let idToken = null;  // tu token Firebase

    // 1) Pide token al usuario (solo para pruebas)
    idToken = prompt('Pega aquí tu Firebase ID token para autenticación:');

    // 2) Carga la lista de perfiles
    fetch(`${apiBase}/profile_list/`)
      .then(res => res.json())
      .then(perfiles => {
        const ul = document.getElementById('list');
        perfiles.forEach(p => {
          const li = document.createElement('li');
          li.textContent = p.username || p.uid;
          li.dataset.uid = p.uid;
          li.onclick = () => selectProfile(li);
          ul.appendChild(li);
        });
      })
      .catch(console.error);

    // 3) Al hacer click en un perfil, inicializa WebSocket
    function selectProfile(li) {
      // Marca activo
      document.querySelectorAll('#profiles li').forEach(x => x.classList.remove('active'));
      li.classList.add('active');

      // Si ya hay socket abierto, ciérralo
      if (socket) socket.close();

      currentRoom = li.dataset.uid;
      openSocket(currentRoom);
    }

    function openSocket(roomName) {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      socket = new WebSocket(`${protocol}://${location.host}/ws/chat/${roomName}/`);

      socket.addEventListener('open', () => {
        // 3.1) Envía mensaje de auth
        socket.send(JSON.stringify({ type: 'auth', token: idToken }));
      });

      socket.addEventListener('message', ev => {
        const data = JSON.parse(ev.data);
        if (data.type === 'auth.success') {
          console.log('Autenticado en sala', roomName);
        } else if (data.type === 'history' || data.type === 'chat.message') {
          appendMessage(data.user, data.message);
        }
      });

      socket.addEventListener('close', ev => {
        console.log('Socket cerrado', ev);
      });

      // 4) Manejar envío de mensajes
      document.getElementById('sendBtn').onclick = sendMessage;
      document.getElementById('msgInput').onkeyup = e => {
        if (e.key === 'Enter') sendMessage();
      };
    }

    function sendMessage() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;
      socket.send(JSON.stringify({ type: 'chat.message', message: text }));
      input.value = '';
    }

    function appendMessage(user, message) {
      const div = document.createElement('div');
      div.className = 'msg ' + (user === 'undefined' || user === null ? 'them' : (user === 'you' ? 'me' : 'them'));
      div.textContent = `${user}: ${message}`;
      document.getElementById('messages').appendChild(div);
      // Auto-scroll
      document.getElementById('messages').scrollTop = 1e9;
    }
  </script>
</body>

</html>
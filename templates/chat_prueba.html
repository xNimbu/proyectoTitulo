<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Chat Prueba</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }

    #chat-log {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 1rem;
      background: #fafafa;
    }

    #chat-log div {
      margin-bottom: 0.5rem;
    }

    #token-input,
    #chat-message-input {
      width: 80%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    #connect-btn,
    #chat-message-submit {
      padding: 0.6rem 1rem;
      font-size: 1rem;
      margin-left: 0.5rem;
    }

    #status {
      margin-bottom: 1rem;
      font-style: italic;
      color: gray;
    }
  </style>
</head>

<body>
  <h1>Chat Prueba</h1>

  <!-- Input para el token -->
  <div>
    <input id="token-input" type="text" placeholder="Pega aquí tu Firebase ID Token">
    <button id="connect-btn">Conectar</button>
  </div>

  <div id="status">Esperando conexión…</div>
  <div id="chat-log"></div>

  <input id="chat-message-input" type="text" placeholder="Escribe tu mensaje…" disabled>
  <button id="chat-message-submit" disabled>Enviar</button>

  <script>
    const statusEl = document.getElementById('status');
    const tokenEl = document.getElementById('token-input');
    const connectBtn = document.getElementById('connect-btn');
    const chatLog = document.getElementById('chat-log');
    const inputEl = document.getElementById('chat-message-input');
    const sendBtn = document.getElementById('chat-message-submit');

    let chatSocket = null;
    let authenticated = false;

    connectBtn.addEventListener('click', () => {
      const token = tokenEl.value.trim();
      if (!token) {
        alert('Debes pegar primero tu Firebase ID Token.');
        return;
      }

      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const roomName = 'prueba';
      const url = `${proto}://${location.host}/ws/chat/${roomName}/`;

      // Limpia log y estado
      chatLog.innerHTML = '';
      statusEl.textContent = 'Conectando…';
      authenticated = false;
      inputEl.disabled = true;
      sendBtn.disabled = true;

      // Cierra socket anterior si existe
      if (chatSocket) chatSocket.close();

      // Abre nuevo websocket
      chatSocket = new WebSocket(url);

      // Al abrir, envía auth
      chatSocket.addEventListener('open', () => {
        chatSocket.send(JSON.stringify({ type: 'auth', token }));
      });

      // Al recibir cualquier mensaje
      chatSocket.addEventListener('message', (e) => {
        const data = JSON.parse(e.data);

        // Si no está autenticado aún, el primer mensaje viene tras auth
        if (!authenticated) {
          authenticated = true;
          statusEl.textContent = 'Conectado';
          inputEl.disabled = false;
          sendBtn.disabled = false;
          inputEl.focus();
          return;  // no mostramos este mensaje en el log
        }

        // Mensajes normales de chat
        const msgEl = document.createElement('div');
        msgEl.textContent = `${data.user}: ${data.message}`;
        chatLog.appendChild(msgEl);
        chatLog.scrollTop = chatLog.scrollHeight;
      });

      // Cuando se cierra la conexión
      chatSocket.addEventListener('close', (e) => {
        console.log('WebSocket cerrado con code:', e.code);
        statusEl.textContent = `Desconectado (code ${e.code})`;
        inputEl.disabled = true;
        sendBtn.disabled = true;
      });

      // Errores de conexión
      chatSocket.addEventListener('error', (err) => {
        console.error('Error en WebSocket:', err);
        statusEl.textContent = 'Error de conexión';
      });
    });

    // Envía mensaje al pulsar botón o Enter
    function sendMessage() {
      const text = inputEl.value.trim();
      if (!text || !authenticated || chatSocket.readyState !== WebSocket.OPEN) return;
      chatSocket.send(JSON.stringify({ message: text }));
      inputEl.value = '';
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>

</html>
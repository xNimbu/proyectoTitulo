<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Chat Prueba</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }

    #chat-log {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 1rem;
      background: #fafafa;
    }

    #chat-log div {
      margin-bottom: 0.5rem;
    }

    #chat-message-input,
    #token-input {
      width: 80%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    #chat-message-submit,
    #connect-btn {
      padding: 0.6rem 1rem;
      font-size: 1rem;
      margin-left: 0.5rem;
    }

    #status {
      margin-bottom: 1rem;
      font-style: italic;
      color: gray;
    }
  </style>
</head>

<body>
  <h1>Chat Prueba</h1>

  <!-- Input para el token -->
  <div>
    <input id="token-input" type="text" placeholder="Pega aquí tu Firebase ID Token">
    <button id="connect-btn">Conectar</button>
  </div>

  <div id="status">Esperando conexión…</div>
  <div id="chat-log"></div>

  <input id="chat-message-input" type="text" placeholder="Escribe tu mensaje…" disabled>
  <button id="chat-message-submit" disabled>Enviar</button>

  <script>
    const statusEl = document.getElementById('status');
    const inputEl = document.getElementById('chat-message-input');
    const btnEl = document.getElementById('chat-message-submit');
    const tokenEl = document.getElementById('token-input');
    const connectBtn = document.getElementById('connect-btn');

    let chatSocket = null;

    connectBtn.addEventListener('click', () => {
      const token = tokenEl.value.trim();
      if (!token) {
        alert('Debes pegar primero tu Firebase ID Token.');
        return;
      }

      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const roomName = 'prueba';
      const socketUrl = `${proto}://${location.host}/ws/chat/${roomName}/?token=${encodeURIComponent(token)}`;

      // Si ya había un socket, ciérralo antes de abrir otro
      if (chatSocket) {
        chatSocket.close();
      }

      statusEl.textContent = 'Conectando…';
      chatSocket = new WebSocket(socketUrl);

      chatSocket.addEventListener('open', () => {
        statusEl.textContent = 'Conectado';
        inputEl.disabled = false;
        btnEl.disabled = false;
        inputEl.focus();
      });

      chatSocket.addEventListener('message', (e) => {
        const data = JSON.parse(e.data);
        const log = document.getElementById('chat-log');
        const msg = document.createElement('div');
        msg.textContent = `${data.user}: ${data.message}`;
        log.appendChild(msg);
        log.scrollTop = log.scrollHeight;
      });

      chatSocket.addEventListener('close', () => {
        statusEl.textContent = 'Desconectado';
        inputEl.disabled = true;
        btnEl.disabled = true;
      });

      chatSocket.addEventListener('error', (err) => {
        console.error('Error en WebSocket:', err);
        statusEl.textContent = 'Error de conexión';
      });
    });

    function sendMessage() {
      const text = inputEl.value.trim();
      if (!text || !(chatSocket && chatSocket.readyState === WebSocket.OPEN)) return;
      chatSocket.send(JSON.stringify({ message: text }));
      inputEl.value = '';
    }

    btnEl.addEventListener('click', sendMessage);
    inputEl.addEventListener('keyup', e => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>

</html>